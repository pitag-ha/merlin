name: Execute privileged instructions

env:
  GH_API_ACTIONS: https://api.github.com/repos/${{ github.repository }}/actions

on:
  workflow_run:
    workflows: ["Foo"]
    types:
      - completed

jobs:
  execute-instruction:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Download instruction artifact
        run: |
          all_artifacts=$(curl -sSL  "$GH_API_ACTIONS/runs/${{ github.event.workflow_run.id }}/artifacts")
          forward_artifact=$(echo $all_artifacts | jq '.artifacts[] | select(.workflow_run.id == ${{ github.event.workflow_run.id }} and .name == "forwarded_instructions")')
          id=$(echo $forward_artifact | jq -r '.id')
          curl -sSLO -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$GH_API_ACTIONS/artifacts/$id/zip" -D headers.txt
      - name: Unzip artifact
        run: |
          unzip -q zip -d forward || (cat zip && cat headers.txt)
      - name: Retreive instruction contents
        id: instruction
        run: |
          instruction=$(jq '.instruction' forward/instruction.json)
          echo "instruction=$instruction | tee -a $GITHUB_OUTPUT
          endpoint=$(jq '.endpoint' forward/instruction.json)
          echo "endpoint=$endpoint | tee -a $GITHUB_OUTPUT
      - name: Delete the label
        if: steps.instruction.outputs.instruction == 'delete_label'
        run: |
          LABEL_NAME=$(cat .github/workflows/fuzzy-ci-helpers/label_name.txt)
          curl -sL -w "%{http_code}" -o output.txt -X DELETE -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "${{ steps.instruction.outputs.endpoint }}/$LABEL_NAME"
      - name: Print http code
        run: cat output.txt
