name: Execute privileged instructions`

env:
  GH_API_ARTIFACTS: https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts

on:
  workflow_run:
    workflows: ["Foo"]
    types:
      - completed

jobs:
  execute-instruction:
    runs-on: ubuntu-latest
    # permissions: write-all
    steps:
      - name: Print pull_request context
        run: |
          echo ${{ toJson(github.event.workflow_run) }}
      - name: Download artifact
        run: |
          all_artifacts=$(curl -sSL  "$GH_API_ARTIFACTS")
          forward_artifact=$(echo $all_artifacts | jq '.artifacts[] | select(.workflow_run.id == ${{ github.event.workflow_run.id }} and .name == "forwarded_instructions")')
          id=$(echo $forward_artifact | jq -r '.id')
          curl -sSLO -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$GH_API_ARTIFACTS/$id/zip" -D headers.txt

      - name: Unzip artifact
        run: |
          unzip -q forward.zip -d forward
          cat forward/instruction.json
